/**************************
* Prüft ob im Internet eine neue Firmwarer verfügbar ist
* 
* 19.03.19 V1.00    Erste Version
**************************/
var logging = true; 
var debugging = true;  
var CCU_Version = 2;        //Hier die nr der CCU eintragen 2 = CCU2 oder 3 = CCU3
//Datenpunkt auswählen wo die installierte Version ersichtlich ist (aus Homematic.Rega Adapter)
var id_Version_installiert = "hm-rega.0.MEQ0228930.0.FIRMWARE_VERSION"/*hm-rega.0.MEQ0228930.0.FIRMWARE_VERSION*/;
var id_Version_Internet = 'Systemvariable.0.Servicemeldungen.Verfuegbare_CCU-Firmware'/*Verfuegbare CCU-Firmware*/

var observation = false;         //Dauerhafte Überwachung der Firmware (true = aktiv // false =inaktiv)
var onetime = true;             //Prüft beim Scriptstart auf aktuelle Firmware

//Prio für Pushover
var prio_Firmware = 0;


//Variablen für Pushover
var sendpush = true;            //true = verschickt per Pushover Nachrchten // false = Pushover wird nicht benutzt
var _prio;
var _titel;
var _message;
var _device = 'TPhone';         //Welches Gerät soll die Nachricht bekommen
//var _device = 'All'; 

//Variablen für Telegram
var sendtelegram = false;            //true = verschickt per Telegram Nachrchten // false = Telegram wird nicht benutzt
var user_telegram = '';             //User der die Nachricht bekommen soll

//Variable zum verschicken der Servicemeldungen per eMail
var sendmail = false;            //true = verschickt per email Nachrchten // false = email wird nicht benutzt


// ab hier keine Änderung

var _message_tmp;


function send_pushover_V4 (_device, _message, _titel, _prio) {
        var pushover_Instanz =  'pushover.0';
        if (_prio === 0){pushover_Instanz =  'pushover.0'}
        else if (_prio == 1){pushover_Instanz =  'pushover.1'}
        else if (_prio == 2){pushover_Instanz =  'pushover.2'}
        else {pushover_Instanz =  'pushover.3'}
        sendTo(pushover_Instanz, { 
        device: _device,
        message: _message, 
        title: _titel, 
        priority: _prio,
        retry: 60,
        expire: 600,
        html: 1
    }); 
}

function send_telegram (_message, user_telegram) {
    sendTo('telegram.0', { 
        text: _message,
        user: user_telegram,
        parse_mode: 'HTML'
    }); 

}

function send_mail (_message) {
    sendTo("email", {
        //from:    "iobroker@mydomain.com",
        //to:      "aabbcc@gmail.com",
        subject: "Servicemeldung",
        text:    _message
    });


}

function func_Version(){
    var Version_Internet = getState(id_Version_Internet).val;
    var ccu2 = 'http://update.homematic.com/firmware/download?cmd=js_check_version&version=12345&product=HM-CCU2&serial=12345';
    var ccu3 = 'http://update.homematic.com/firmware/download?cmd=js_check_version&version=12345&product=HM-CCU3&serial=12345';
    var ccu;
    if(CCU_Version == 3){ccu = ccu3;}
    else{ccu = ccu2;}

    var request = require('request'),
    url = ccu;

    request({url : url},

        function (error, response, body) {
            var Version_installiert = (getState(id_Version_installiert).val).trim();
            var Version = body.split("'");
            if(error){
                log('error: ' + error);
            }
            else{
                if(Version_Internet == ''){
                    if(debugging){
                        log('[DEBUG] ' +'Objekt leer. Firmware wird erstmalig gesetzt');
                    }
                    setState(id_Version_Internet,Version[1]);
                }
                
                if(Version_installiert == Version[1]){
                    if(debugging){
                        log('[DEBUG] ' +'Installierte Firmware der CCU ist aktuell');
                    }
                }
                else{
                    if(debugging){
                        log('[DEBUG] ' +'Installierte Firmware der CCU ist nicht aktuell. Installiert: ' +Version_installiert +' --- Verfügbare Version: '+Version[1]);
                    }
                    
                    if(Version_Internet == Version[1]){
                        if(debugging){
                            log('[DEBUG] ' +'Version Internet hat sich nicht verändert');
                        }
                    }
                    else{
                        if(debugging){
                            log('Installierte Firmware der CCU ist nicht aktuell. Installiert: ' +Version_installiert +' --- Verfügbare Version: '+Version[1]);
                        }
                        setState(id_Version_Internet,Version[1]);
                         _message_tmp = 'Installierte Firmware der CCU ist nicht aktuell. Installiert: ' +Version_installiert +' --- Verfügbare Version: '+Version[1];
                        //Push verschicken
                        if(sendpush){
                            _prio = prio_Firmware;
                            _titel = 'CCU-Firmware';
                            _message = _message_tmp;
                            send_pushover_V4(_device, _message, _titel, _prio);
                        }
                        if(sendtelegram){
                            _message = _message_tmp;
                            send_telegram(_message, user_telegram);
                        }
                        if(sendmail){
                            _message = _message_tmp;
                            send_mail(_message);
                        }
                    }
                
                    
                   
                }
        
                if(debugging){
                    //log('body: ' + body);
                    log('Länge ' + Version.length + ' --- Version: ' + Version[1]);
                    log('response: ' + JSON.stringify(response));
                }
            }
        }

    );
    
}

if(observation){
    //Nachts einmalig ausführen 00:30 Schaltzeiten berechnen
    schedule("54 05 * * *", func_Version);
}

if(onetime){
    //beim Starten
    func_Version();
}
